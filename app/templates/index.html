<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Carb Counter</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; }
    .container { max-width: 600px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1, h2 { text-align: center; color: #4a4a4a; }
    h1 small { font-size: 0.6em; color: #888; display: block; }
    h2 .undo-link { font-size: 0.6em; font-weight: normal; margin-left: 10px; }
    form { display: flex; flex-direction: column; gap: 15px; }
    input[type="text"] { padding: 15px; font-size: 1.2em; border: 1px solid #ccc; border-radius: 5px; }
    button[type="submit"] { padding: 15px; font-size: 1.2em; font-weight: bold; color: #fff; background-color: #007bff; border: none; border-radius: 5px; cursor: pointer; }
    .total-carbs { font-size: 2em; font-weight: bold; text-align: center; color: #d9534f; margin: 20px 0; }
    .average-carbs { font-size: 1.5em; font-weight: bold; text-align: center; color: #5cb85c; margin-bottom: 20px; }
    ul { list-style-type: none; padding: 0; }
    li { background-color: #f9f9f9; padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 1.1em; }
    .delete-item { color: #dc3545; text-decoration: none; font-weight: bold; margin-left: 15px; }
    .nav-link { display: block; text-align: center; margin-top: 20px; color: #007bff; text-decoration: none; font-size: 1.1em; }
    .clear-link { color: #dc3545; }
    .error-box { background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-bottom: 20px; text-align: center; }
    .search-container { display: flex; align-items: center; }
    #food-input { flex-grow: 1; }
    #mic-button { padding: 15px; font-size: 1.2em; margin-left: 10px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; }
    #ios-tip, #mic-unsupported { text-align: center; font-size: 0.9em; color: #6c757d; margin-top: 0; }

    .tutorial-box {
      background-color: #e9f5ff;
      border-left: 5px solid #007bff;
      padding: 15px;
      margin: 15px 0 20px 0;
      border-radius: 5px;
      font-size: 1em;
    }
    .tutorial-box button {
      margin-top: 10px;
      padding: 6px 12px;
      font-size: 0.9em;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Dad's Carb Counter <small>Viewing: {{ display_date_str }}</small></h1>

    {% if not request.cookies.get('seen_tutorial') %}
    <div id="tutorial-box" class="tutorial-box">
      <p><strong>How to use this:</strong></p>
      <ul>
        <li>Type what you ate. Example: <em>1 apple and 2 slices of toast</em></li>
        <li>Or click the üé§ button to speak</li>
        <li>Click ‚ÄúAdd Food‚Äù ‚Äî we‚Äôll show the carb breakdown</li>
      </ul>
      <button onclick="dismissTutorial()">Got it!</button>
    </div>
    {% endif %}

    {% if error %}
    <div class="error-box">{{ error }}</div>
    {% endif %}

    {% if viewing_today %}
    <form action="/" method="post">
      <div class="search-container">
        <input id="food-input" list="food-suggestions" type="text" name="food_query" placeholder="e.g., 1 apple and toast" required />
        <button type="button" id="mic-button">üé§</button>
      </div>
      <datalist id="food-suggestions">
        {% for suggestion in suggestions %}
        <option value="{{ suggestion }}">
        {% endfor %}
      </datalist>
      <button type="submit">Add Food</button>
    </form>
    <p id="ios-tip" style="display: none;">Tip: Tap the microphone on your keyboard to use voice input!</p>
    <p id="mic-unsupported" style="display: none;">Voice input not supported in this browser. Try Safari on iPhone.</p>
    {% endif %}

    <h2>Total Carbs</h2>
    <div class="total-carbs">{{ total_carbs|round(1) }} g</div>

    <h2>7-Day Average</h2>
    <div class="average-carbs">{{ average_7_days }} g</div>

    <h2>Logbook
      {% if viewing_today and food_log %}
      <a href="/undo" class="undo-link">(undo last)</a>
      {% endif %}
    </h2>

    <ul>
      {% for item in food_log %}
      <li>
        <span>
          {{ item.food.title() }}
          {% if item.serving_qty and item.serving_unit %}
            ‚Äî {{ item.serving_qty }} serving{{ 's' if item.serving_qty > 1 }} ({{ item.serving_unit }})
          {% endif %}
          ‚Äî <strong>{{ item.carbs|round(1) }} g</strong>
        </span>
        <a href="/delete/{{ display_date_raw }}/{{ loop.index0 }}" class="delete-item">(x)</a>
      </li>
      {% endfor %}
    </ul>

    <a href="/history" class="nav-link">View History</a>
    {% if food_log %}
    <a href="/clear/{{ display_date_raw }}" class="nav-link clear-link">Clear This Day's Log</a>
    {% endif %}

    <p style="text-align: center; margin-top: 20px;">
      <a href="https://ko-fi.com/johnkelly33759" target="_blank" style="color: #007bff; text-decoration: none;">
        ‚òï Support this app on Ko-fi
      </a>
    </p>

    <script>
      function dismissTutorial() {
        document.getElementById("tutorial-box").style.display = "none";
        document.cookie = "seen_tutorial=true; path=/; max-age=" + (60 * 60 * 24 * 365);
      }

      window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

      const micButton = document.getElementById('mic-button');
      const foodInput = document.getElementById('food-input');
      const iosTip = document.getElementById('ios-tip');
      const micUnsupported = document.getElementById('mic-unsupported');

      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

      if (window.SpeechRecognition) {
        const recognition = new SpeechRecognition();

        recognition.onresult = function(event) {
          const transcript = event.results[0][0].transcript;
          foodInput.value = transcript;
        };

        micButton.addEventListener('click', function () {
          try {
            recognition.start();
            foodInput.placeholder = 'Listening...';
          } catch (e) {
            alert('Speech recognition is not available or is already active.');
          }
        });

        recognition.onspeechend = function () {
          recognition.stop();
          foodInput.placeholder = 'e.g., 1 apple and toast';
        };

      } else {
        micButton.style.display = 'none';

        if (isIOS) {
          iosTip.style.display = 'block';
        } else {
          micUnsupported.style.display = 'block';
        }
      }
    </script>
  </div>
</body>
</html>
